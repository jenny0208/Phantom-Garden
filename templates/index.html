<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Phantom Garden - 11功能最终考证版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #010103; color: #fff; overflow: hidden; font-family: 'Inter', sans-serif; transition: background 2s; }
        canvas { display: block; position: fixed; inset: 0; z-index: 0; }
        
        /* 功能 1: 蓝色发光发送键 */
        .btn-send { color: #3b82f6; filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.8)); cursor: pointer; transition: 0.3s; }
        .btn-send:hover { transform: scale(1.15); color: #60a5fa; }

        /* 功能 2: 线性时间轴视觉 */
        #timeline-wrapper { position: absolute; bottom: 85px; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.1); pointer-events: none; }
        .time-mark { position: absolute; display: flex; flex-direction: column; align-items: center; transform: translateX(-50%); transition: 0.8s ease-out; }
        .time-node { width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; box-shadow: 0 0 15px #3b82f6; border: 2px solid #fff; }
        .time-label { color: rgba(255,255,255,0.6); font-size: 10px; margin-top: 10px; font-family: monospace; white-space: nowrap; }

        /* 基础 UI 组件 */
        .glass-panel { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(50px); border: 1px solid rgba(255, 255, 255, 0.35); border-radius: 32px; padding: 40px; }
        #focus-panel { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.92); }
        #scroll-wrapper { position: fixed; inset: 0; z-index: 10; overflow-x: auto; display: flex; align-items: center; padding: 0 10vw; scrollbar-width: none; transition: opacity 0.8s; }
        
        .memory-card { flex: 0 0 320px; height: 450px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.2); margin-right: 110px; border-radius: 24px; overflow: hidden; cursor: pointer; z-index: 20; transition: 0.4s; }
        .memory-card:hover { border-color: #3b82f6; background: rgba(255,255,255,0.1); }

        /* 功能 3: 音频引擎音浪 */
        #music-toggle { position: fixed; bottom: 30px; right: 30px; z-index: 100; display: none; cursor: pointer; }
        .music-bar { width: 4px; height: 16px; background: #3b82f6; margin: 0 2px; display: inline-block; box-shadow: 0 0 8px #3b82f6; }
        .playing .music-bar { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { height: 8px; } 50% { height: 20px; } }

        /* 功能 4: 崩坏效果 */
        .collapse-active { background: #1a0000 !important; }
        .collapse-active .time-node { background: #ef4444; box-shadow: 0 0 15px #ef4444; }
        
        .tool-btn { font-size: 11px; border: 1px solid rgba(255,255,255,0.4); padding: 8px 20px; border-radius: 30px; cursor: pointer; background: rgba(0,0,0,0.4); color: white; transition: 0.3s; }
    </style>
</head>
<body>
    <audio id="bg-music" loop><source src="/templates/Moonloops.MP3" type="audio/mpeg"></audio>

    <div class="fixed top-8 left-8 z-[120] flex gap-4">
        <div class="tool-btn" onclick="shareGarden()">分享花园链接</div>
        <div class="tool-btn" onclick="if(confirm('清空所有记忆？')){localStorage.clear();location.reload();}">重置</div>
    </div>

    <div id="setup-overlay" class="fixed inset-0 z-[150] bg-[#010103] flex items-center justify-center">
        <div class="glass-panel text-center w-96">
            <h2 class="text-[10px] tracking-[0.5em] mb-8 opacity-40 uppercase">Awaiting Identity</h2>
            <input type="text" id="ai-name-input" class="bg-transparent border-b border-white/30 w-full text-center py-3 outline-none mb-12 text-2xl font-light" placeholder="给它取个名字...">
            <button onclick="startGarden()" class="border border-white/50 px-16 py-3 rounded-full text-xs hover:bg-white/10 transition">唤醒花园</button>
        </div>
    </div>

    <div id="container"></div>

    <div id="scroll-wrapper" style="opacity: 0;">
        <div id="gallery-tracks" class="relative flex items-center min-w-full h-full">
            <div id="timeline-wrapper"></div>
        </div>
    </div>

    <div id="focus-panel">
        <div class="glass-panel w-[640px]">
            <div id="chat-box" class="h-[380px] overflow-y-auto mb-6 pr-2 space-y-6"></div>
            <div class="flex items-center border-t border-white/10 pt-6 mb-8">
                <input type="text" id="msg-in" class="bg-transparent flex-1 outline-none text-lg" placeholder="在此输入记忆碎片...">
                <button onclick="sendMsg()" class="btn-send ml-4">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </div>
            <div class="flex justify-between items-center">
                <button onclick="closeFocus()" class="text-xs opacity-40 hover:opacity-100 transition">返回花园</button>
                <button id="save-btn" onclick="archive()" class="bg-blue-600/30 border border-blue-500/50 text-blue-200 px-10 py-3 rounded-full text-xs hover:bg-blue-600/50 transition">封存这段记忆</button>
            </div>
        </div>
    </div>

    <div id="music-toggle" onclick="toggleMsc()">
        <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
    </div>

    <div class="fixed bottom-12 w-full flex justify-center z-50">
        <label id="up-btn" class="hidden cursor-pointer bg-white/5 border border-white/20 px-16 py-5 rounded-full text-xs tracking-widest hover:bg-white/10 transition">
            开启新记忆切片 <input type="file" id="file-in" class="hidden" accept="image/*">
        </label>
    </div>

    <script>
        let scene, camera, renderer, pts, curImg, history = [], ai = "Elysia", count = 0, memories = [];

        // 功能 10: 分享解析与自动注入
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            if (data) {
                try {
                    const decoded = decodeURIComponent(escape(atob(data)));
                    localStorage.setItem('pg_11_final', decoded);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    alert("成功加载他人的记忆花园！");
                } catch (e) { console.error("解析失败", e); }
            }
        };

        function startGarden() {
            const n = document.getElementById('ai-name-input').value; if(n) ai = n;
            document.getElementById('bg-music').play().then(() => {
                document.getElementById('music-toggle').classList.add('playing');
                document.getElementById('music-toggle').style.display = 'block';
            });
            document.getElementById('setup-overlay').style.display = 'none';
            document.getElementById('up-btn').style.display = 'block';
            document.getElementById('scroll-wrapper').style.opacity = '1';
            init3D(); loadLocal();
        }

        // 功能 11: 持久化存储加载
        function loadLocal() {
            const raw = localStorage.getItem('pg_11_final');
            if(!raw) return;
            const data = JSON.parse(raw);
            ai = data.ai; count = data.count; memories = data.memories;
            memories.forEach((m, i) => renderCard(m, i));
            checkCollapse();
        }

        async function sendMsg() {
            const input = document.getElementById('msg-in');
            const val = input.value.trim(); if(!val) return;
            document.getElementById('chat-box').innerHTML += `<div class="text-right text-white/70">${val}</div>`;
            input.value = '';

            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: val, history: history, ai_name: ai, memory_count: count })
            });
            const d = await res.json();
            // 显示后端逻辑流
            let logic = d.logic_raw ? `<div class="text-[9px] text-red-500 font-mono mb-1 opacity-60">[SYS_LOGIC]: ${d.logic_raw}</div>` : "";
            document.getElementById('chat-box').innerHTML += `<div class="text-left text-blue-200">${logic}${ai}: ${d.reply}</div>`;
            history.push({role:"user", content:val}, {role:"assistant", content:d.reply});
            document.getElementById('chat-box').scrollTop = 9999;
        }

        function archive() {
            const title = prompt("为这段记忆命名", "未命名碎片");
            if(title === null) return;
            const entry = {
                title: title || "无名碎片", img: curImg, history: [...history],
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                idx: count
            };
            memories.push(entry);
            renderCard(entry, memories.length - 1);
            count++;
            localStorage.setItem('pg_11_final', JSON.stringify({ ai, count, memories }));
            checkCollapse(); closeFocus();
        }

        function renderCard(data, i) {
            const card = document.createElement('div');
            card.className = "memory-card";
            card.innerHTML = `<div style="height:220px; background:url(${data.img || ''}) center/cover; background-color:#111; opacity:0.8"></div><div class="p-8"><div class="text-blue-400 font-bold text-sm mb-2">${data.title}</div><div class="opacity-30 text-[9px] uppercase">Frag_${data.idx}</div></div>`;
            card.onclick = () => {
                if(data.img) makeParticles(data.img);
                document.getElementById('chat-box').innerHTML = data.history.map(h => `<div class="${h.role==='user'?'text-right text-white/70':'text-left text-blue-200'}">${h.role==='assistant'?ai+': ':''}${h.content}</div>`).join('');
                openFocus(false);
            };
            document.getElementById('gallery-tracks').appendChild(card);

            const node = document.createElement('div');
            node.className = "time-mark";
            node.style.left = (i * 430) + 160 + "px";
            node.innerHTML = `<div class="time-node"></div><div class="time-label">${data.time}</div>`;
            document.getElementById('timeline-wrapper').appendChild(node);
        }

        function shareGarden() {
            // 分享逻辑：剔除超大图片 Base64 以保证 URL 可用
            const liteData = {
                ai, count, memories: memories.map(m => ({...m, img: null})) 
            };
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(liteData))));
            const url = window.location.origin + window.location.pathname + "?data=" + encoded;
            navigator.clipboard.writeText(url).then(() => alert("分享链接已复制（已精简图片数据以确保链接有效）"));
        }

        // 图像粒子化引擎
        function init3D() { scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 1, 1000); camera.position.z = 160; renderer = new THREE.WebGLRenderer({alpha:true, antialias:true}); renderer.setSize(innerWidth, innerHeight); document.getElementById('container').appendChild(renderer.domElement); loop(); }
        function loop() { requestAnimationFrame(loop); if(pts) pts.rotation.y += 0.0008; renderer.render(scene, camera); }
        function makeParticles(src) {
            const img = new Image(); img.src = src;
            img.onload = () => {
                const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                cvs.width = 100; cvs.height = 100; ctx.drawImage(img,0,0,100,100);
                const pix = ctx.getImageData(0,0,100,100).data;
                if(pts) scene.remove(pts);
                const geo = new THREE.BufferGeometry(), pos = [], col = [];
                for(let i=0; i<10000; i++) {
                    pos.push((i%100-50)*2.4, (50-Math.floor(i/100))*2.4, (pix[i*4]/255)*12);
                    col.push(pix[i*4]/255, pix[i*4+1]/255, pix[i*4+2]/255);
                }
                geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                geo.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
                pts = new THREE.Points(geo, new THREE.PointsMaterial({size:1.1, vertexColors:true, transparent:true, opacity:0.8}));
                scene.add(pts);
            };
        }

        function checkCollapse() { if(count >= 10) { document.body.classList.add('collapse-active'); if(pts) pts.material.color.setHex(0xff3333); } }
        document.getElementById('file-in').onchange = (e) => {
            const fr = new FileReader();
            fr.onload = (r) => { curImg = r.target.result; history = []; makeParticles(curImg); openFocus(true); document.getElementById('chat-box').innerHTML=""; };
            fr.readAsDataURL(e.target.files[0]);
        };
        function openFocus(e) { document.getElementById('scroll-wrapper').style.opacity='0'; document.getElementById('focus-panel').style.display='flex'; document.getElementById('save-btn').style.display=e?'block':'none'; }
        function closeFocus() { document.getElementById('focus-panel').style.display='none'; document.getElementById('scroll-wrapper').style.opacity='1'; }
        function toggleMsc() { const m = document.getElementById('bg-music'); m.paused ? m.play() : m.pause(); document.getElementById('music-toggle').classList.toggle('playing'); }
    </script>
</body>
</html>
