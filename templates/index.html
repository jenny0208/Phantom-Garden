<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Phantom Garden - 11功能考证版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #010103; color: #fff; overflow: hidden; font-family: 'Inter', sans-serif; }
        canvas { display: block; position: fixed; inset: 0; z-index: 0; }
        
        /* 1. 蓝色发光按键 UI */
        .btn-send { color: #3b82f6; filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.8)); transition: 0.3s; cursor: pointer; }
        .btn-send:hover { transform: scale(1.2); color: #60a5fa; }

        /* 2. 时间轴视觉 */
        #timeline-wrapper { position: absolute; bottom: 80px; left: 0; width: 100%; height: 60px; pointer-events: none; }
        .time-mark { position: absolute; display: flex; flex-direction: column; align-items: center; transform: translateX(-50%); transition: 0.5s; }
        .time-node { width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; box-shadow: 0 0 15px #3b82f6; border: 2px solid #fff; }
        .time-label { color: rgba(255,255,255,0.6); font-size: 10px; margin-top: 8px; font-family: monospace; white-space: nowrap; }

        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 30px; padding: 40px; }
        #focus-panel { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); }
        #scroll-wrapper { position: fixed; inset: 0; z-index: 10; overflow-x: auto; display: flex; align-items: center; padding: 0 10vw; scrollbar-width: none; }
        
        .memory-card { flex: 0 0 300px; height: 420px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); margin-right: 120px; border-radius: 20px; overflow: hidden; cursor: pointer; z-index: 20; }
        
        #music-toggle { position: fixed; bottom: 30px; right: 30px; z-index: 100; display: none; cursor: pointer; }
        .music-bar { width: 4px; height: 16px; background: #3b82f6; margin: 0 2px; display: inline-block; }
        .playing .music-bar { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { height: 8px; } 50% { height: 20px; } }

        .collapse-mode { background: #200 !important; }
        .collapse-mode .time-node { background: #f00; box-shadow: 0 0 15px #f00; }
    </style>
</head>
<body>
    <audio id="bg-music" loop><source src="/templates/Moonloops.MP3" type="audio/mpeg"></audio>

    <div id="setup-overlay" class="fixed inset-0 z-[150] bg-[#010103] flex items-center justify-center">
        <div class="glass-panel text-center w-80">
            <h2 class="text-xs tracking-widest mb-6 opacity-50">INITIATING IDENTITY</h2>
            <input type="text" id="ai-name-input" class="bg-transparent border-b border-white/40 w-full text-center py-2 outline-none mb-10 text-2xl" placeholder="给它取个名字...">
            <button onclick="startGarden()" class="border border-white/50 px-10 py-3 rounded-full text-xs hover:bg-white/10">唤醒</button>
        </div>
    </div>

    <div id="container"></div>

    <div id="scroll-wrapper" style="opacity: 0;">
        <div id="gallery-tracks" class="relative flex items-center min-w-full h-full">
            <div id="timeline-wrapper">
                <div style="position:absolute; top:25px; left:0; width:5000px; height:1px; background:rgba(255,255,255,0.1);"></div>
            </div>
        </div>
    </div>

    <div id="focus-panel">
        <div class="glass-panel w-[600px]">
            <div id="dialogue-box" class="h-80 overflow-y-auto mb-6 space-y-4 pr-2"></div>
            <div class="flex items-center border-t border-white/10 pt-6">
                <input type="text" id="user-msg" class="bg-transparent flex-1 outline-none" placeholder="请描述图片或者说点什么……">
                <button onclick="sendMsg()" class="btn-send ml-4">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </div>
            <div class="flex justify-between mt-8">
                <button onclick="closeFocus()" class="text-[10px] opacity-40 hover:opacity-100">返回</button>
                <button id="save-btn" onclick="archiveMemory()" class="bg-blue-500/20 border border-blue-500/50 text-blue-300 px-8 py-2 rounded-full text-[10px]">保存记忆</button>
            </div>
        </div>
    </div>

    <div id="music-toggle" onclick="toggleMsc()">
        <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
    </div>

    <div class="fixed bottom-10 w-full flex justify-center z-50">
        <label id="up-btn" class="hidden cursor-pointer bg-white/5 border border-white/20 px-12 py-4 rounded-full text-[10px] tracking-widest hover:bg-white/10 transition">
            上传新切片 <input type="file" id="file-in" class="hidden" accept="image/*">
        </label>
    </div>

    <script>
        let scene, camera, renderer, pts, curImg, history = [], ai = "Elysia", count = 0, memories = [];

        function startGarden() {
            const n = document.getElementById('ai-name-input').value;
            if(n) ai = n;
            document.getElementById('bg-music').play();
            document.getElementById('setup-overlay').style.display = 'none';
            document.getElementById('music-toggle').style.display = 'block';
            document.getElementById('up-btn').style.display = 'block';
            document.getElementById('scroll-wrapper').style.opacity = '1';
            init3D();
            loadAll();
        }

        // 功能 8: 持久化加载
        function loadAll() {
            const data = localStorage.getItem('pg_11_v1');
            if(data) {
                const parsed = JSON.parse(data);
                ai = parsed.ai; count = parsed.count; memories = parsed.memories;
                memories.forEach((m, i) => drawMemory(m, i));
                checkCollapse();
            }
        }

        async function sendMsg() {
            const el = document.getElementById('user-msg');
            const txt = el.value.trim(); if(!txt) return;
            document.getElementById('dialogue-box').innerHTML += `<div class="text-right text-white/60">${txt}</div>`;
            el.value = '';

            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: txt, history: history, ai_name: ai, memory_count: count })
            });
            const d = await res.json();
            // 功能 9: 后端逻辑流显示
            let log = d.logic_raw ? `<div class="text-[9px] text-red-500 font-mono mb-1">[SYS]: ${d.logic_raw}</div>` : "";
            document.getElementById('dialogue-box').innerHTML += `<div class="text-left text-blue-200">${log}${ai}: ${d.reply}</div>`;
            history.push({role:"user", content:txt}, {role:"assistant", content:d.reply});
            document.getElementById('dialogue-box').scrollTop = 999;
        }

        // 功能 6: 取名 + 功能 5: 存档
        function archiveMemory() {
            const name = prompt("给这段记忆起个名字", "未命名记忆");
            if(name === null) return;
            const entry = {
                id: count, title: name || "碎片", img: curImg, 
                history: [...history], 
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            };
            memories.push(entry);
            drawMemory(entry, memories.length - 1);
            count++;
            // 功能 8: 持久化写入
            localStorage.setItem('pg_11_v1', JSON.stringify({ ai, count, memories }));
            checkCollapse();
            closeFocus();
        }

        function drawMemory(data, i) {
            const card = document.createElement('div');
            card.className = "memory-card";
            card.innerHTML = `<div style="height:200px; background:url(${data.img}) center/cover"></div><div class="p-6"><div class="text-blue-400 font-bold text-sm mb-1">${data.title}</div><div class="opacity-30 text-[9px]">INDEX_${data.id}</div></div>`;
            card.onclick = () => {
                makeParticles(data.img);
                document.getElementById('dialogue-box').innerHTML = data.history.map(h => `<div class="${h.role==='user'?'text-right text-white/60':'text-left text-blue-200'}">${h.role==='assistant'?ai+': ':''}${h.content}</div>`).join('');
                openFocus(false);
            };
            document.getElementById('gallery-tracks').appendChild(card);

            // 功能 2: 时间轴节点渲染
            const node = document.createElement('div');
            node.className = "time-mark";
            node.style.left = (i * 420) + 150 + "px";
            node.innerHTML = `<div class="time-node"></div><div class="time-label">${data.time}</div>`;
            document.getElementById('timeline-wrapper').appendChild(node);
        }

        // 功能 10: 粒子化引擎
        function init3D() { scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 1, 1000); camera.position.z = 150; renderer = new THREE.WebGLRenderer({alpha:true}); renderer.setSize(innerWidth, innerHeight); document.getElementById('container').appendChild(renderer.domElement); loop(); }
        function loop() { requestAnimationFrame(loop); if(pts) pts.rotation.y += 0.001; renderer.render(scene, camera); }
        function makeParticles(src) {
            const img = new Image(); img.src = src;
            img.onload = () => {
                const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                cvs.width = 100; cvs.height = 100; ctx.drawImage(img,0,0,100,100);
                const pix = ctx.getImageData(0,0,100,100).data;
                if(pts) scene.remove(pts);
                const geo = new THREE.BufferGeometry(), p = [], c = [];
                for(let i=0; i<10000; i++) {
                    p.push((i%100-50)*2.5, (50-Math.floor(i/100))*2.5, (pix[i*4]/255)*10);
                    c.push(pix[i*4]/255, pix[i*4+1]/255, pix[i*4+2]/255);
                }
                geo.setAttribute('position', new THREE.Float32BufferAttribute(p, 3));
                geo.setAttribute('color', new THREE.Float32BufferAttribute(c, 3));
                pts = new THREE.Points(geo, new THREE.PointsMaterial({size:1.2, vertexColors:true, transparent:true, opacity:0.8}));
                scene.add(pts);
            };
        }

        // 功能 11: 自动崩坏系统
        function checkCollapse() { if(count >= 10) { document.body.classList.add('collapse-mode'); if(pts) pts.material.color.setHex(0xff0000); } }

        document.getElementById('file-in').onchange = (e) => {
            const fr = new FileReader();
            fr.onload = (r) => { curImg = r.target.result; history = []; makeParticles(curImg); openFocus(true); };
            fr.readAsDataURL(e.target.files[0]);
        };

        function openFocus(e) { document.getElementById('scroll-wrapper').style.opacity='0'; document.getElementById('focus-panel').style.display='flex'; document.getElementById('save-btn').style.display=e?'block':'none'; }
        function closeFocus() { document.getElementById('focus-panel').style.display='none'; document.getElementById('scroll-wrapper').style.opacity='1'; }
        function toggleMsc() { const m = document.getElementById('bg-music'); m.paused ? m.play() : m.pause(); document.getElementById('music-toggle').classList.toggle('playing'); }
    </script>
</body>
</html>
